<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Panel Skrining — Client</title>
<style>
  :root{
    --bg:#f5f7fb; --card:#ffffff; --muted:#64748b; --accent:#2563eb;
    --border:#e2e8f0; --danger:#d9534f;
  }
  html,body{height:100%}
  body{font-family:Inter,Arial,Helvetica,sans-serif;margin:12px;background:var(--bg);color:#0b1220}
  .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 8px 24px rgba(2,6,23,0.06)}
  .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:8px;margin-top:10px}
  table{border-collapse:collapse;width:100%;min-width:1000px;table-layout:fixed;font-size:13px}
  th,td{padding:6px;border-right:1px solid rgba(15,23,42,0.04);text-align:center;white-space:nowrap;vertical-align:middle}
  thead th{background:#f8fafc;position:sticky;top:0;z-index:3}
  select{padding:4px 6px;border-radius:6px}
  .controls{margin-top:10px;display:flex;gap:8px;justify-content:space-between;align-items:center}
  button{padding:8px 12px;border-radius:6px;background:var(--accent);color:#fff;border:0;cursor:pointer}
  .small{font-size:13px;color:var(--muted)}
  pre.json{background:#0b1220;color:#e6eef8;padding:8px;border-radius:6px}
  .antibody-badge { display:inline-block;background-color:var(--danger);color:white;padding:4px 10px;margin:3px;border-radius:4px;font-weight:700;font-size:13px; }
  .highlight-antigen{background-color:rgba(255,0,0,0.12) !important}
  .meta{margin-top:8px;color:var(--muted);font-size:13px}
  .analysis{margin-top:12px;padding:10px;border-radius:8px;background:#fff;border:1px solid #e6edf3}
  .note{color:var(--muted);font-size:13px;margin-top:6px}
  @media (max-width:700px){ table{min-width:900px;font-size:12px} }
</style>
</head>
<body>
  <div class="card">
    <h2>Panel Skrining — Client</h2>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="refreshBtn">Refresh data</button>
      <div id="meta" class="meta">Memuat...</div>
    </div>

    <div id="tableWrap" class="table-wrap" role="region" aria-label="Panel skrining"></div>

    <div class="controls">
      <div style="display:flex;gap:8px;align-items:center">
        <button id="analyzeBtn">Analyze</button>
        <button id="saveBtn">Save local</button>
        <button id="loadBtn">Load local</button>
        <button id="exportBtn">Export JSON</button>
      </div>
      <div id="status" class="small"></div>
    </div>

    <div id="analysisContainer"></div>
    <pre id="jsonOut" class="json" style="display:none"></pre>
  </div>

<script>
/*
  panel_client.html (final)
  - reads /panel.json
  - antigen columns are read dynamically from header (structure A: first column 'Sel', second may be 'Ref' or an antigen)
  - ensures 20°C/37°C/IAT/Gel are on the right
  - highlights entire antigen columns for candidate antibodies
*/

// helper: fetch panel.json
async function fetchPanel(){
  const resp = await fetch('/panel.json');
  if(!resp.ok) throw new Error('Gagal fetch /panel.json');
  return resp.json();
}

function mkSelect(cell, type){
  const opts = ['?','Negatif','m.f','w','1+','2+','3+','4+','n.t'];
  const s = document.createElement('select');
  s.dataset.cell = cell;
  s.dataset.type = type;
  opts.forEach(o => {
    const op = document.createElement('option'); op.value = o; op.textContent = o;
    s.appendChild(op);
  });
  s.value = '?';
  return s;
}

function normalizeKey(k){ return (k===undefined || k===null) ? '' : String(k).trim(); }

function antigenPresent(val){
  if(val === undefined || val === null) return false;
  const v = String(val).trim();
  if(v === '' || v === '0' || v.toLowerCase() === 'negatif' || v === '-') return false;
  return true;
}

// render table dynamically
let lastPanelData = null;
let renderedAntigenKeys = []; // keep for analysis and highlight
let headerStartIndex = 1; // default: 1 => column 0 = Sel, column 1 = first antigen or Ref

function renderTable(j){
  const wrap = document.getElementById('tableWrap');
  if(!j || !j.ok){
    wrap.innerHTML = '<div style="padding:12px;">Tidak ada data (periksa antigram.xlsx)</div>';
    lastPanelData = null;
    document.getElementById('meta').textContent = 'Tidak ada data';
    return;
  }
  lastPanelData = j.data;
  const data = j.data;
  wrap.innerHTML = '';

  // Determine antigen keys:
  // Prefer header row if provided by server (j.header)
  // We'll detect first header word 'sel' at index 0; if header[1] looks like 'ref' we'll treat as Ref present.
  let antigenKeys = [];
  let headerRow = Array.isArray(j.header) ? j.header.map(h => normalizeKey(h)) : [];
  if(headerRow.length >= 2 && headerRow[0].toLowerCase().includes('sel')){
    // decide whether header[1] is Ref or an antigen name
    const h1 = headerRow[1] ? headerRow[1].toLowerCase() : '';
    const hasRef = h1 === 'ref' || h1 === 'ref.' || h1.includes('ref');
    headerStartIndex = hasRef ? 2 : 1;
    // collect headers from headerStartIndex until we hit known test columns (20°C,37°C,IAT,Gel) or end
    const stopNames = new Set(['20°c','20c','20°','20°','37°c','37c','iat','gel','hasil pemeriksaan','hasil']);
    for(let i = headerStartIndex; i < headerRow.length; i++){
      const low = headerRow[i].toLowerCase();
      if(stopNames.has(low)) break;
      if(headerRow[i]) antigenKeys.push(headerRow[i]);
    }
  }

  // Fallback: build antigen keys from union of data.cells[*].antigen
  if(antigenKeys.length === 0 && data.cells && data.cells.length){
    const s = new Set();
    data.cells.forEach(c => {
      const ant = c.antigen || {};
      Object.keys(ant).forEach(k => {
        const kk = normalizeKey(k);
        if(kk) s.add(kk);
      });
    });
    antigenKeys = Array.from(s);
    // as a fallback, keep order from a typical list if present
  }

  // Clean antigen keys: remove accidental 'Sel','Ref','No','20°C' etc
  const excluded = new Set(['sel','ref','no','no.','merk','lot','exp','20°c','20c','20°','37°c','37c','iat','gel','hasil pemeriksaan','hasil']);
  antigenKeys = antigenKeys.filter(k => k && !excluded.has(k.toLowerCase()));

  // Keep order stable (as found), store globally
  renderedAntigenKeys = antigenKeys.slice();

  // Build table with grouped headers (we will keep simple: one top row with grouping for 'Antigen' and second row with antigen names,
  // but to preserve readability we include Sel and Ref as fixed.)
  const table = document.createElement('table');

  // thead: two rows
  const thead = document.createElement('thead');

  const tr1 = document.createElement('tr');
  const thSel = document.createElement('th'); thSel.rowSpan = 2; thSel.textContent = 'Sel'; tr1.appendChild(thSel);
  // decide if Ref present
  const hasRefColumn = (j.header && j.header[1] && String(j.header[1]).toLowerCase().includes('ref')) || false;
  let thRef = null;
  if(hasRefColumn){
    thRef = document.createElement('th'); thRef.rowSpan = 2; thRef.textContent = 'Ref.'; tr1.appendChild(thRef);
    headerStartIndex = 2;
  } else {
    // keep headerStartIndex default 1
    headerStartIndex = 1;
  }

  // One group header spanning all antigen keys (label "Antigen")
  const thAntGroup = document.createElement('th'); thAntGroup.colSpan = Math.max(1, renderedAntigenKeys.length); thAntGroup.textContent = 'Antigen'; tr1.appendChild(thAntGroup);

  const thNo = document.createElement('th'); thNo.rowSpan = 2; thNo.textContent = 'No'; tr1.appendChild(thNo);
  const thHasil = document.createElement('th'); thHasil.colSpan = 4; thHasil.textContent = 'Hasil Pemeriksaan'; tr1.appendChild(thHasil);
  thead.appendChild(tr1);

  // second header row: antigen names + 20C/37C/IAT/Gel
  const tr2 = document.createElement('tr');
  renderedAntigenKeys.forEach(k => {
    const th = document.createElement('th'); th.textContent = k; tr2.appendChild(th);
  });
  ['20°C','37°C','IAT','Gel'].forEach(h => {
    const th = document.createElement('th'); th.textContent = h; tr2.appendChild(th);
  });
  thead.appendChild(tr2);
  table.appendChild(thead);

  // tbody
  const tbody = document.createElement('tbody');
  (data.cells || []).forEach((rowObj, idx) => {
    const tr = document.createElement('tr');
    const tdSel = document.createElement('td'); tdSel.textContent = rowObj.sel || (idx+1); tr.appendChild(tdSel);
    if(hasRefColumn){
      const tdRef = document.createElement('td'); tdRef.textContent = rowObj.ref || ''; tr.appendChild(tdRef);
    }
    const ant = rowObj.antigen || {};
    renderedAntigenKeys.forEach(k => {
      const td = document.createElement('td'); td.className = 'antigen'; td.textContent = (ant[k] === undefined || ant[k] === null) ? '' : String(ant[k]); tr.appendChild(td);
    });
    const tdNo = document.createElement('td'); tdNo.textContent = idx+1; tr.appendChild(tdNo);

    tr.appendChild((()=>{ const td=document.createElement('td'); td.appendChild(mkSelect(idx+1,'20c')); return td })());
    tr.appendChild((()=>{ const td=document.createElement('td'); td.appendChild(mkSelect(idx+1,'37c')); return td })());
    tr.appendChild((()=>{ const td=document.createElement('td'); td.appendChild(mkSelect(idx+1,'iat')); return td })());
    tr.appendChild((()=>{ const td=document.createElement('td'); td.appendChild(mkSelect(idx+1,'gel')); return td })());

    tbody.appendChild(tr);
  });

  // Auto control: put label in first cell(s), span antigen columns
  const trAuto = document.createElement('tr');
  const tdAutoLabel = document.createElement('td'); 
  // span label over Sel (+ Ref if present)
  tdAutoLabel.colSpan = hasRefColumn ? 2 : 1;
  tdAutoLabel.textContent = 'Auto Kontrol'; trAuto.appendChild(tdAutoLabel);

  const tdFill = document.createElement('td'); tdFill.colSpan = Math.max(1, renderedAntigenKeys.length); tdFill.textContent = ''; trAuto.appendChild(tdFill);
  const tdNoAuto = document.createElement('td'); tdNoAuto.textContent = ''; trAuto.appendChild(tdNoAuto);
  ['20c','37c','iat','gel'].forEach(type => {
    const td = document.createElement('td'); td.appendChild(mkSelect('auto', type)); trAuto.appendChild(td);
  });
  tbody.appendChild(trAuto);

  table.appendChild(tbody);
  wrap.appendChild(table);

  // meta text
  document.getElementById('meta').textContent = `Merk: ${data.meta.merk||'-'}  Lot: ${data.meta.lot||'-'}  Exp: ${data.meta.exp||'-'}`;
  document.getElementById('status').textContent = '';
}

// refresh
async function refresh(){
  try {
    document.getElementById('status').textContent = 'Memuat...';
    const j = await fetchPanel();
    renderTable(j);
    document.getElementById('status').textContent = 'Data terupdate';
  } catch(err){
    document.getElementById('status').textContent = 'Gagal load: ' + (err.message || err);
    document.getElementById('tableWrap').innerHTML = '';
  }
}

// reactive check
function isReactive(v){
  if(!v) return false;
  const vv = String(v).trim().toLowerCase();
  if(vv === '?' || vv === 'negatif' || vv === 'n.t' || vv === 'nt') return false;
  if(['w','m.f','mf','mf.','mf'].includes(vv)) return true;
  if(/[1-4]\+/.test(vv)) return true;
  if(vv === '+' || /^\+{1,4}$/.test(vv)) return true;
  return false;
}

// highlight antigen columns by names (case-insensitive)
function highlightAntigenColumnsByNames(names){
  const table = document.querySelector('table');
  if(!table) return;
  // clear previous highlights
  table.querySelectorAll('.highlight-antigen').forEach(el => el.classList.remove('highlight-antigen'));
  if(!names || names.length === 0) return;

  // compute starting column index in rows: Sel (0) then maybe Ref (1). antigen headers are in thead tr:nth-child(2)
  const headerRow2 = table.querySelectorAll('thead tr:nth-child(2) th');
  const headerNames = Array.from(headerRow2).map(h => h.innerText.trim().toLowerCase());
  const bodyRows = Array.from(table.querySelectorAll('tbody tr'));

  names.forEach(n => {
    const target = String(n).trim().toLowerCase();
    const i = headerNames.findIndex(h => h === target);
    if(i >= 0){
      // absolute column index in row children = (hasRef ? 2 : 1) + i
      // detect if Ref exists by checking number of columns before ant in first header row
      const thSel = table.querySelector('thead tr:first-child th');
      const nBeforeAnt = Array.from(table.querySelectorAll('thead tr:first-child th')).reduce((acc, th, idx) => {
        // find the ant group header which text is 'Antigen' or first group; we know ant columns start after Sel and maybe Ref
        return acc + 0;
      }, 0);
      // simpler: compute colIndex = index of matching th in thead tr:nth-child(2) plus offset of how many fixed columns exist before ant columns
      // Count fixed columns in DOM: first header row children until we reach the group 'Antigen' (which spans ant cols). But easiest: compute offset = total children of first header row minus total children of second header row between antigen start and tests.
      // Simpler and reliable: find first row's children and find position of the first th that contains 'Antigen' or that has colspan equal to rendered ant length.
      let offset = 1; // default Sel only
      const firstRowThs = Array.from(table.querySelectorAll('thead tr:first-child th'));
      // find if there is an extra second fixed column (Ref) by checking firstRowThs[1] text equals 'Ref.' or firstRowThs[1].rowSpan===2
      if(firstRowThs.length > 1 && firstRowThs[1].rowSpan === 2 && firstRowThs[1].innerText.trim().toLowerCase().includes('ref')) {
        offset = 2;
      } else {
        // if firstRowThs[1] is the 'Antigen' group (colSpan > 1), offset remains 1
        offset = 1;
      }
      const colIndex = offset + i;
      // add highlight to the header cell in row2
      const headerCell = headerRow2[i];
      if(headerCell) headerCell.classList.add('highlight-antigen');
      // add highlight to body cells at that column index
      bodyRows.forEach(row => {
        const cell = row.children[colIndex];
        if(cell) cell.classList.add('highlight-antigen');
      });
    }
  });
}

// ANALYSIS (strict rule)
function analyzePanel(){
  const selects = Array.from(document.querySelectorAll('select[data-cell]'));
  const byCell = {};
  selects.forEach(s => {
    const id = s.dataset.cell;
    byCell[id] = byCell[id] || {};
    byCell[id][s.dataset.type] = s.value;
  });

  // auto control
  const autoVals = selects.filter(s => s.dataset.cell === 'auto').map(s => s.value);
  const autoPositive = autoVals.some(isReactive);
  const autoStatus = autoPositive ? 'Positif' : 'Negatif';
  const autoCauses = autoPositive ? ['autoantibodi','alloantibodi terhadap antigen dengan fenotipe sama','cold agglutinin','reaksi nonspesifik (mis. hiperprotein, obat, dll)'] : [];

  if(!lastPanelData) return alert('Tidak ada data panel (refresh dulu).');
  const cells = lastPanelData.cells || [];

  // build rows with test results
  const rows = cells.map((c, idx) => {
    const id = String(idx+1);
    const r = { sel: c.sel || (idx+1), ref: c.ref||'', antigen: c.antigen||{}, results: byCell[id] || {'20c':'?','37c':'?','iat':'?','gel':'?'} };
    r.reactive = isReactive(r.results['20c']) || isReactive(r.results['37c']) || isReactive(r.results['iat']) || isReactive(r.results['gel']);
    r.reactiveTests = [];
    if(isReactive(r.results['20c'])) r.reactiveTests.push('20°C');
    if(isReactive(r.results['37c'])) r.reactiveTests.push('37°C');
    if(isReactive(r.results['iat'])) r.reactiveTests.push('IAT');
    if(isReactive(r.results['gel'])) r.reactiveTests.push('Gel');
    return r;
  });

  const reactiveRows = rows.filter(r=>r.reactive);
  const nonReactiveRows = rows.filter(r=>!r.reactive);

  // determine antigen keys same as rendered
  const antigenKeys = renderedAntigenKeys.slice();

  // strict candidates: antigen present in ALL reactiveRows and absent in ALL nonReactiveRows
  const strictCandidates = [];
  antigenKeys.forEach(key=>{
    if(reactiveRows.length === 0) return;
    const presentAll = reactiveRows.every(r => antigenPresent(r.antigen[key]));
    const absentAllNon = nonReactiveRows.every(r => !antigenPresent(r.antigen[key]));
    if(presentAll && absentAllNon) strictCandidates.push(key);
  });

  // interpret per row
  const interpretPerRow = rows.map(r => `Sel ${r.sel} (Ref ${r.ref}): ${r.reactive ? 'REAKTIF' : 'NEGATIF'} — reaksi pada: ${r.reactiveTests.join(', ') || '-'}`).join('\n');

  // conclusion
  let conclusion = '';
  if(reactiveRows.length === 0){
    conclusion = 'Tidak ditemukan sel reaktif pada suhu 20°/37°C/IAT/Gel.';
  } else if(strictCandidates.length === 0){
    conclusion = 'Tidak ditemukan kandidat antibodi spesifik dengan aturan strict. Pertimbangkan pemeriksaan lanjutan.';
  } else {
    conclusion = `Ditemukan kemungkinan antibodi: ${strictCandidates.map(s=>'anti-'+s).join(', ')}.`;
  }

  // recommendations
  const recommendations = [];
  if(strictCandidates.length>0) recommendations.push('Lakukan identifikasi antibodi (panel ID) terhadap kandidat teratas untuk konfirmasi.');
  else recommendations.push('Pertimbangkan pemeriksaan panel identifikasi lanjutan atau ulangi uji dengan panel lain.');
  recommendations.push('Periksa riwayat transfusi/kehamilan dan pastikan crossmatch jika diperlukan.');

  const out = {
    interpretPerRow,
    reactiveCount: reactiveRows.length,
    totalCount: rows.length,
    candidates: strictCandidates,
    conclusion,
    recommendations,
    auto: { status: autoStatus, values: autoVals, causes: autoCauses }
  };

  showAnalysis(out);
  // highlight candidate antigen columns
  highlightAntigenColumnsByNames(strictCandidates);
}

// showAnalysis: display interpretation, candidates, auto control, conclusion
function showAnalysis(out){
  const container = document.getElementById('analysisContainer');
  container.innerHTML = '';
  const el = document.createElement('div');
  el.className = 'analysis';

  // interpretation
  const p = document.createElement('div');
  p.innerHTML = '<strong>Interpretasi per sel</strong>';
  const pre = document.createElement('pre'); pre.style.whiteSpace='pre-wrap'; pre.style.background='#f8fafc'; pre.style.padding='8px'; pre.style.borderRadius='6px';
  pre.textContent = out.interpretPerRow;
  p.appendChild(pre);
  el.appendChild(p);

  // summary
  const sum = document.createElement('div'); sum.style.marginTop='8px';
  sum.innerHTML = `<strong>Ringkasan</strong><div>Sel reaktif: <b>${out.reactiveCount}</b> / ${out.totalCount}</div>`;
  el.appendChild(sum);

  // candidates
  const candDiv = document.createElement('div'); candDiv.style.marginTop='8px';
  candDiv.innerHTML = '<strong>Kemungkinan antibodi:</strong>';
  if(out.candidates && out.candidates.length){
    const wrap = document.createElement('div'); wrap.style.marginTop='6px';
    out.candidates.forEach(c=>{
      const sp = document.createElement('span'); sp.className='antibody-badge'; sp.textContent = 'anti-' + c; wrap.appendChild(sp);
    });
    candDiv.appendChild(wrap);
  } else {
    const none = document.createElement('div'); none.textContent = '- Tidak ada kandidat spesifik (strict matching).'; none.style.marginTop='6px'; candDiv.appendChild(none);
  }
  el.appendChild(candDiv);

  // auto control
  const autoDiv = document.createElement('div'); autoDiv.style.marginTop='10px';
  autoDiv.innerHTML = '<strong>Auto Kontrol</strong>';
  autoDiv.innerHTML += `<div style="margin-top:6px">Status: <b>${out.auto.status}</b></div>`;
  if(out.auto.status === 'Positif'){
    let ul = '<div style="margin-top:6px"><em>Kemungkinan penyebab:</em><ul>';
    out.auto.causes.forEach(c=> ul += `<li>${c}</li>`);
    ul += '</ul></div>';
    autoDiv.innerHTML += ul;
    autoDiv.innerHTML += `<div style="margin-top:6px;color:#9a3b00">Catatan: Auto kontrol positif bisa menunjukkan adanya autoantibodi atau faktor nonspesifik; pertimbangkan pemeriksaan lanjutan (auto-adsorpsi, pemanasan serum, dsb).</div>`;
  } else {
    autoDiv.innerHTML += `<div style="margin-top:6px">Tidak ditemukan reaksi pada auto kontrol.</div>`;
  }
  el.appendChild(autoDiv);

  // conclusion & recommendation
  const concl = document.createElement('div'); concl.style.marginTop='10px';
  concl.innerHTML = `<strong>Kesimpulan / rekomendasi</strong><div style="margin-top:6px">${out.conclusion.replace(/\n/g,'<br>')}</div>`;
  let rec = '<div style="margin-top:8px"><em>Rekomendasi:</em><ul>';
  out.recommendations.forEach(r=> rec += `<li>${r}</li>`);
  rec += '</ul></div>';
  concl.innerHTML += rec;
  el.appendChild(concl);

  container.appendChild(el);
}

// local save/load/export
document.getElementById('refreshBtn').addEventListener('click', refresh);
document.getElementById('analyzeBtn').addEventListener('click', analyzePanel);
document.getElementById('saveBtn').addEventListener('click', ()=>{
  const selects = document.querySelectorAll('select[data-cell]');
  const out = {};
  selects.forEach(s => {
    const id = s.dataset.cell;
    out[id] = out[id] || {};
    out[id][s.dataset.type] = s.value;
  });
  localStorage.setItem('panel_local', JSON.stringify(out));
  alert('Tersimpan ke localStorage');
});
document.getElementById('loadBtn').addEventListener('click', ()=>{
  const raw = localStorage.getItem('panel_local');
  if(!raw) return alert('Tidak ada data tersimpan');
  const obj = JSON.parse(raw);
  Object.keys(obj).forEach(k => {
    const r = obj[k];
    Object.keys(r).forEach(t => {
      const s = document.querySelector('select[data-cell="'+k+'"][data-type="'+t+'"]');
      if(s) s.value = r[t];
    });
  });
  alert('Data dimuat dari localStorage');
});
document.getElementById('exportBtn').addEventListener('click', ()=>{
  const selects = document.querySelectorAll('select[data-cell]');
  const out = {};
  selects.forEach(s => {
    const id = s.dataset.cell;
    out[id] = out[id] || {};
    out[id][s.dataset.type] = s.value;
  });
  const b = new Blob([JSON.stringify(out, null, 2)], { type: 'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'panel_results.json'; a.click(); URL.revokeObjectURL(a.href);
});

window.addEventListener('load', refresh);
</script>
</body>
</html>
