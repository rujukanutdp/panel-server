<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Panel Skrining — Client (Sinkron Antigram)</title>
<style>
  :root{
    --bg:#f5f7fb;
    --card:#ffffff;
    --muted:#64748b;
    --accent:#2563eb;
    --border:#e2e8f0;
    --danger:#d9534f;
  }
  html,body{height:100%}
  body{
    font-family:Inter,Arial,Helvetica,sans-serif;
    margin:12px;
    background:var(--bg);
    color:#0b1220;
  }
  .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 8px 24px rgba(2,6,23,0.06)}
  .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:8px;margin-top:10px}
  table{border-collapse:collapse;width:100%;min-width:900px;table-layout:fixed;font-size:13px}
  th,td{padding:6px;border-right:1px solid rgba(15,23,42,0.04);text-align:center;white-space:nowrap;vertical-align:middle}
  thead th{background:#f8fafc;position:sticky;top:0;z-index:2}
  select{padding:4px 6px;border-radius:6px}
  .controls{margin-top:10px;display:flex;gap:8px;justify-content:space-between;align-items:center}
  button{padding:8px 12px;border-radius:6px;background:var(--accent);color:#fff;border:0;cursor:pointer}
  .small{font-size:13px;color:var(--muted)}
  .antibody-badge { display:inline-block;background-color:var(--danger);color:white;padding:4px 10px;margin:3px;border-radius:4px;font-weight:700;font-size:13px; }
  .highlight-antigen{background-color:rgba(255,0,0,0.12) !important}
  .meta{margin-top:8px;color:var(--muted);font-size:13px}
  .analysis{margin-top:12px;padding:10px;border-radius:8px;background:#fff;border:1px solid #e6edf3}
</style>
</head>
<body>
  <div class="card">
    <h2>Panel Skrining — Client (Sinkron Excel)</h2>

    <div style="display:flex;gap:8px;align-items:center">
      <button id="refreshBtn">Refresh data</button>
      <div id="meta" class="meta">Memuat...</div>
    </div>

    <div id="tableWrap" class="table-wrap"></div>

    <div class="controls">
      <div style="display:flex;gap:8px">
        <button id="analyzeBtn">Analyze</button>
        <button id="saveBtn">Save local</button>
        <button id="loadBtn">Load local</button>
        <button id="exportBtn">Export JSON</button>
      </div>
      <div id="status" class="small"></div>
    </div>

    <div id="analysisContainer"></div>
  </div>

<script>
let lastPanelData=null;
let antigenKeys=[];

async function fetchPanel(){
  const resp=await fetch('/panel.json');
  if(!resp.ok) throw new Error('Gagal fetch /panel.json');
  return resp.json();
}

function mkSelect(cell,type,defaultValue){
  const opts=['?','Negatif','m.f','w','1+','2+','3+','4+','n.t'];
  const s=document.createElement('select');
  s.dataset.cell=cell;s.dataset.type=type;
  opts.forEach(o=>{const op=document.createElement('option');op.value=o;op.textContent=o;s.appendChild(op);});
  s.value=opts.includes(defaultValue)?defaultValue:'?';
  return s;
}

function normalizeKey(k){return String(k||'').trim();}

function renderTable(panelJson){
  const wrap=document.getElementById('tableWrap');
  if(!panelJson||!panelJson.ok){wrap.innerHTML='<div style="padding:12px;">Tidak ada data</div>';return;}

  lastPanelData=panelJson.data||{};
  const header=Array.isArray(panelJson.header)?panelJson.header.map(h=>normalizeKey(h)):[];
  const cells=panelJson.data?.cells||[];

  // antigenKeys dari header: ambil semua kolom setelah Ref sampai sebelum 20oC
  let refIndex=header.findIndex(h=>h.toLowerCase().includes('ref'));
  let start=refIndex+1;
  let end=header.findIndex(h=>/20|37|iat|gel/i.test(h));
  if(end<0) end=header.length;
  antigenKeys=header.slice(start,end);

  wrap.innerHTML='';
  const table=document.createElement('table');

  // Header 2 baris
  const thead=document.createElement('thead');
  const tr1=document.createElement('tr');
  tr1.innerHTML=`<th rowspan="2">Sel</th><th colspan="${antigenKeys.length}">Antigen</th><th rowspan="2">No</th><th colspan="4">Hasil Pemeriksaan</th>`;
  thead.appendChild(tr1);

  const tr2=document.createElement('tr');
  antigenKeys.forEach(k=>{const th=document.createElement('th');th.textContent=k;tr2.appendChild(th);});
  ['20°C','37°C','IAT','Gel'].forEach(k=>{const th=document.createElement('th');th.textContent=k;tr2.appendChild(th);});
  thead.appendChild(tr2);
  table.appendChild(thead);

  const tbody=document.createElement('tbody');
  const localSaved=JSON.parse(localStorage.getItem('panel_local')||'{}');

  cells.forEach((row,idx)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${row.sel||idx+1}</td>`;
    antigenKeys.forEach(k=>{
      const td=document.createElement('td');
      const ant=row.antigen||{};
      const val=ant[k]??ant[Object.keys(ant).find(x=>x.toLowerCase()===k.toLowerCase())]||'';
      td.textContent=val;tr.appendChild(td);
    });
    tr.innerHTML+=`<td>${idx+1}</td>`;
    ['20c','37c','iat','gel'].forEach(t=>{
      const td=document.createElement('td');
      td.appendChild(mkSelect(idx+1,t,localSaved[idx+1]?.[t]||''));tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });

  // Auto Kontrol
  const trA=document.createElement('tr');
  trA.innerHTML=`<td>Auto Kontrol</td><td colspan="${antigenKeys.length+1}"></td>`;
  const auto=panelJson.data?.auto||{};
  ['20c','37c','iat','gel'].forEach(t=>{
    const td=document.createElement('td');td.appendChild(mkSelect('auto',t,auto[t]||''));trA.appendChild(td);
  });
  tbody.appendChild(trA);

  table.appendChild(tbody);wrap.appendChild(table);

  document.getElementById('meta').textContent=`Merk: ${panelJson.data.meta?.merk||'-'} | Lot: ${panelJson.data.meta?.lot||'-'} | Exp: ${panelJson.data.meta?.exp||'-'}`;
  document.getElementById('status').textContent='';
}

function isReactive(v){
  if(!v)return false;
  const vv=String(v).trim().toLowerCase();
  if(['?','negatif','n.t','nt','0','-'].includes(vv))return false;
  return true;
}

// ... fungsi analyzePanel(), showAnalysis(), save/load/export TETAP SAMA ...
// (tidak diubah sama sekali dari file sebelumnya)
</script>
</body>
</html>
