<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Panel Skrining — Client</title>
<style>
  body{font-family:Inter,Arial,Helvetica,sans-serif;margin:12px;background:#f5f7fb;color:#0b1220}
  .card{background:#fff;padding:14px;border-radius:10px;box-shadow:0 8px 24px rgba(2,6,23,0.06)}
  .table-wrap{overflow:auto;border:1px solid #e2e8f0;border-radius:8px;margin-top:10px}
  table{border-collapse:collapse;width:100%;min-width:1100px;table-layout:fixed}
  th,td{padding:6px;border-right:1px solid rgba(15,23,42,0.04);text-align:center;white-space:nowrap}
  th{background:#f8fafc;position:sticky;top:0}
  select{padding:4px 6px;border-radius:6px}
  .controls{margin-top:10px;display:flex;gap:8px;justify-content:space-between}
  button{padding:8px 12px;border-radius:6px;background:#2563eb;color:#fff;border:0;cursor:pointer}
  .small{font-size:13px;color:#64748b}
</style>
</head>
<body>
  <div class="card">
    <h2>Panel Skrining — (dari server)</h2>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="refreshBtn">Refresh data</button>
      <div id="meta" class="small"></div>
    </div>

    <div id="tableWrap" class="table-wrap"></div>

    <div class="controls">
      <div>
        <button id="analyzeBtn">Analyze</button>
        <button id="saveBtn">Save local</button>
        <button id="loadBtn">Load local</button>
        <button id="exportBtn">Export JSON</button>
      </div>
      <div id="status" class="small"></div>
    </div>

    <pre id="jsonOut" style="display:none;background:#0b1220;color:#e6eef8;padding:8px;border-radius:6px"></pre>
  </div>

<script>
async function fetchPanel(){
  const resp = await fetch('/panel.json');
  if(!resp.ok) throw new Error('Gagal fetch /panel.json');
  return resp.json();
}

function mkSelect(cell, type){
  const opts = ['?','Negatif','m.f','w','1+','2+','3+','4+','n.t'];
  const s = document.createElement('select');
  s.dataset.cell = cell;
  s.dataset.type = type;
  opts.forEach(o => {
    const op = document.createElement('option'); op.value = o; op.textContent = o;
    s.appendChild(op);
  });
  s.value = '?';
  return s;
}

function renderTable(j){
  if(!j || !j.ok) {
    document.getElementById('tableWrap').innerHTML = '<div style="padding:12px;">Tidak ada data (periksa antigram.xlsx)</div>';
    return;
  }
  const data = j.data;
  const wrap = document.getElementById('tableWrap');
  wrap.innerHTML = '';
  const table = document.createElement('table');

  // header (two rows)
  const thead = document.createElement('thead');
  const tr1 = document.createElement('tr');
  const thSel = document.createElement('th'); thSel.rowSpan=2; thSel.textContent='Sel'; tr1.appendChild(thSel);
  const thRef = document.createElement('th'); thRef.rowSpan=2; thRef.textContent='Ref.'; tr1.appendChild(thRef);
  tr1.appendChild(Object.assign(document.createElement('th'),{colSpan:5,textContent:'Rh'}));
  tr1.appendChild(Object.assign(document.createElement('th'),{colSpan:2,textContent:'Kell'}));
  tr1.appendChild(Object.assign(document.createElement('th'),{colSpan:2,textContent:'Duffy'}));
  tr1.appendChild(Object.assign(document.createElement('th'),{colSpan:2,textContent:'Kidd'}));
  tr1.appendChild(Object.assign(document.createElement('th'),{colSpan:4,textContent:'MNS'}));
  const thP1 = document.createElement('th'); thP1.rowSpan=2; thP1.textContent='P1'; tr1.appendChild(thP1);
  tr1.appendChild(Object.assign(document.createElement('th'),{colSpan:2,textContent:'Lewis'}));
  tr1.appendChild(Object.assign(document.createElement('th'),{colSpan:2,textContent:'Lutheran'}));
  const thNo = document.createElement('th'); thNo.rowSpan=2; thNo.textContent='No'; tr1.appendChild(thNo);
  tr1.appendChild(Object.assign(document.createElement('th'),{colSpan:4,textContent:'Hasil Pemeriksaan'}));
  thead.appendChild(tr1);

  const tr2 = document.createElement('tr');
  const headers = ['D','C','E','c','e','K','k','Fya','Fyb','Jka','Jkb','M','N','S','s','Lea','Leb','Lua','Lub','20°C','37°C','IAT','Gel'];
  headers.forEach(h => {
    const th = document.createElement('th'); th.textContent = h; tr2.appendChild(th);
  });
  thead.appendChild(tr2);
  table.appendChild(thead);

  const tbody = document.createElement('tbody');
  (data.cells || []).forEach((rowObj, idx) => {
    const tr = document.createElement('tr');
    const tdSel = document.createElement('td'); tdSel.textContent = rowObj.sel || (idx+1); tr.appendChild(tdSel);
    const tdRef = document.createElement('td'); tdRef.textContent = rowObj.ref || ''; tr.appendChild(tdRef);

    const ant = rowObj.antigen || {};
    ['D','C','E','c','e','K','k','Fya','Fyb','Jka','Jkb','M','N','S','s','P1','Lea','Leb','Lua','Lub'].forEach(k=>{
      const td = document.createElement('td'); td.className = 'antigen'; td.textContent = ant[k] || ''; tr.appendChild(td);
    });

    const tdNo = document.createElement('td'); tdNo.textContent = idx+1; tr.appendChild(tdNo);

    tr.appendChild((()=>{ const td=document.createElement('td'); td.appendChild(mkSelect(idx+1,'20c')); return td })());
    tr.appendChild((()=>{ const td=document.createElement('td'); td.appendChild(mkSelect(idx+1,'37c')); return td })());
    tr.appendChild((()=>{ const td=document.createElement('td'); td.appendChild(mkSelect(idx+1,'iat')); return td })());
    tr.appendChild((()=>{ const td=document.createElement('td'); td.appendChild(mkSelect(idx+1,'gel')); return td })());

    tbody.appendChild(tr);
  });

  // auto control
  const trAuto = document.createElement('tr');
  const tdAuto = document.createElement('td'); tdAuto.colSpan = 23; tdAuto.textContent = 'Auto Kontrol'; trAuto.appendChild(tdAuto);
  ['20c','37c','iat','gel'].forEach(type => {
    const td = document.createElement('td'); td.appendChild(mkSelect('auto', type)); trAuto.appendChild(td);
  });
  tbody.appendChild(trAuto);

  table.appendChild(tbody);
  wrap.appendChild(table);

  // meta
  document.getElementById('meta').textContent = `Merk: ${data.meta.merk||'-'}  Lot: ${data.meta.lot||'-'}  Exp: ${data.meta.exp||'-'}`;
}

// fetch + render
async function refresh(){
  try {
    document.getElementById('status').textContent = 'Memuat...';
    const j = await fetch('/panel.json').then(r => r.json());
    renderTable(j);
    document.getElementById('status').textContent = 'Data terupdate';
  } catch(err) {
    document.getElementById('status').textContent = 'Gagal load: ' + (err.message || err);
    document.getElementById('tableWrap').innerHTML = '';
  }
}

// simple analyze function
function isReactive(v){
  if(!v) return false;
  if(['?','Negatif','n.t'].includes(v)) return false;
  return ['w','1+','2+','3+','4+'].includes(v);
}

document.getElementById('refreshBtn').addEventListener('click', refresh);
document.getElementById('analyzeBtn').addEventListener('click', ()=>{
  const selects = document.querySelectorAll('select[data-cell]');
  const data = {};
  selects.forEach(s => {
    const id = s.dataset.cell;
    data[id] = data[id] || {};
    data[id][s.dataset.type] = s.value;
  });
  const autos = Array.from(document.querySelectorAll('select[data-cell="auto"]')).map(s => s.value);
  if (autos.some(isReactive)) return alert('HASIL: TIDAK VALID (Auto kontrol reaktif)');
  let any=false;
  for(const k in data){
    if (k === 'auto') continue;
    const r = data[k];
    if (isReactive(r['iat']) || isReactive(r['37c']) || isReactive(r['gel'])) { any=true; break; }
  }
  alert(any ? 'SKRINING: POSITIF' : 'SKRINING: NEGATIF');
});

document.getElementById('saveBtn').addEventListener('click', ()=>{
  const selects = document.querySelectorAll('select[data-cell]');
  const out = {};
  selects.forEach(s => {
    const id = s.dataset.cell;
    out[id] = out[id] || {};
    out[id][s.dataset.type] = s.value;
  });
  localStorage.setItem('panel_local', JSON.stringify(out));
  alert('Tersimpan ke localStorage');
});
document.getElementById('loadBtn').addEventListener('click', ()=>{
  const raw = localStorage.getItem('panel_local');
  if(!raw) return alert('Tidak ada data tersimpan');
  const obj = JSON.parse(raw);
  Object.keys(obj).forEach(k => {
    const r = obj[k];
    Object.keys(r).forEach(t => {
      const s = document.querySelector('select[data-cell="'+k+'"][data-type="'+t+'"]');
      if(s) s.value = r[t];
    });
  });
  alert('Data dimuat dari localStorage');
});

document.getElementById('exportBtn').addEventListener('click', ()=>{
  const selects = document.querySelectorAll('select[data-cell]');
  const out = {};
  selects.forEach(s => {
    const id = s.dataset.cell;
    out[id] = out[id] || {};
    out[id][s.dataset.type] = s.value;
  });
  const b = new Blob([JSON.stringify(out, null, 2)], { type: 'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'panel_results.json'; a.click(); URL.revokeObjectURL(a.href);
});

window.addEventListener('load', refresh);
</script>
</body>
</html>
