<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Panel Skrining — Client</title>
<style>
  :root{
    --bg:#f5f7fb; --card:#ffffff; --muted:#64748b; --accent:#2563eb;
    --border:#e2e8f0; --danger:#d9534f;
  }
  html,body{height:100%}
  body{font-family:Inter,Arial,Helvetica,sans-serif;margin:12px;background:var(--bg);color:#0b1220}
  .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 8px 24px rgba(2,6,23,0.06)}
  .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:8px;margin-top:10px}
  table{border-collapse:collapse;width:100%;min-width:900px;table-layout:fixed;font-size:13px}
  th,td{padding:6px;border-right:1px solid rgba(15,23,42,0.04);text-align:center;white-space:nowrap;vertical-align:middle}
  th{background:#f8fafc;position:sticky;top:0;z-index:2}
  select{padding:4px 6px;border-radius:6px}
  .controls{margin-top:10px;display:flex;gap:8px;justify-content:space-between;align-items:center}
  button{padding:8px 12px;border-radius:6px;background:var(--accent);color:#fff;border:0;cursor:pointer}
  .small{font-size:13px;color:var(--muted)}
  pre.json{background:#0b1220;color:#e6eef8;padding:8px;border-radius:6px}
  /* antibody badge */
  .antibody-badge { display:inline-block;background-color:var(--danger);color:white;padding:4px 10px;margin:3px;border-radius:4px;font-weight:700;font-size:13px; }
  /* highlighted column */
  .highlight-antigen{background-color:rgba(255,0,0,0.12) !important}
  .meta{margin-top:8px;color:var(--muted);font-size:13px}
  .analysis{margin-top:12px;padding:10px;border-radius:8px;background:#fff;border:1px solid #e6edf3}
  @media (max-width:700px){ table{min-width:800px;font-size:12px}}
</style>
</head>
<body>
  <div class="card">
    <h2>Panel Skrining — Client</h2>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="refreshBtn">Refresh data</button>
      <div id="meta" class="meta">Memuat...</div>
    </div>

    <div id="tableWrap" class="table-wrap" role="region" aria-label="Panel skrining"></div>

    <div class="controls">
      <div style="display:flex;gap:8px;align-items:center">
        <button id="analyzeBtn">Analyze</button>
        <button id="saveBtn">Save local</button>
        <button id="loadBtn">Load local</button>
        <button id="exportBtn">Export JSON</button>
      </div>
      <div id="status" class="small"></div>
    </div>

    <div id="analysisContainer"></div>
    <pre id="jsonOut" class="json" style="display:none"></pre>
  </div>

<script>
/*
  panel_client.html
  - reads /panel.json (served by server.js)
  - renders table dynamically from header/antigen keys
  - allows entering test results per cell (20c,37c,iat,gel)
  - Analyze uses strict logic: antigen present in ALL reactive rows and absent in ALL non-reactive rows -> candidate
  - Highlights entire antigen columns for candidates
*/

let lastPanelData = null;

async function fetchPanel(){
  const resp = await fetch('/panel.json');
  if(!resp.ok) throw new Error('Gagal fetch /panel.json');
  return resp.json();
}

function mkSelect(cell, type){
  const opts = ['?','Negatif','m.f','w','1+','2+','3+','4+','n.t'];
  const s = document.createElement('select');
  s.dataset.cell = cell;
  s.dataset.type = type;
  opts.forEach(o => {
    const op = document.createElement('option'); op.value = o; op.textContent = o;
    s.appendChild(op);
  });
  s.value = '?';
  return s;
}

function antigenPresent(val){
  if(val === undefined || val === null) return false;
  const v = String(val).trim();
  if(v === '' || v === '0' || v.toLowerCase() === 'negatif' || v === '-' ) return false;
  return true;
}

function renderTable(j){
  const wrap = document.getElementById('tableWrap');
  if(!j || !j.ok) {
    wrap.innerHTML = '<div style="padding:12px;">Tidak ada data (periksa antigram.xlsx)</div>';
    lastPanelData = null;
    document.getElementById('meta').textContent = 'Tidak ada data';
    return;
  }
  lastPanelData = j.data;
  const data = j.data;
  wrap.innerHTML = '';

  // determine antigen keys: prefer explicit header mapping if available; otherwise collect keys from first cell antigen object
  let antigenKeys = [];
  if (Array.isArray(j.header) && j.header.length > 0) {
    // try to find antigen-like names in header: filter out known non-antigen columns like Sel, Ref, No, 20°C etc.
    const ignore = ['sel','ref','no','no.','no. lot','merk','exp','20°c','20°c','20°c','20°','20°C','37°c','37°C','iat','gel','hasil pemeriksaan','hasil'];
    antigenKeys = j.header.map(h => (h||'').toString().trim()).filter(h=>{
      if(!h) return false;
      const low = h.toLowerCase();
      return !ignore.includes(low);
    });
  }
  if(antigenKeys.length === 0 && data.cells && data.cells.length){
    antigenKeys = Object.keys(data.cells[0].antigen || {}).filter(k => k && k !== 'undefined');
  }
  // normalize antigenKeys: keep order, remove empties
  antigenKeys = antigenKeys.map(k => String(k).trim()).filter(k => k);

  // build table
  const table = document.createElement('table');

  const thead = document.createElement('thead');
  const tr1 = document.createElement('tr');
  const thSel = document.createElement('th'); thSel.rowSpan=2; thSel.textContent='Sel'; tr1.appendChild(thSel);
  const thRef = document.createElement('th'); thRef.rowSpan=2; thRef.textContent='Ref.'; tr1.appendChild(thRef);

  // group headers based on antigen count: for simplicity show one "Antigen" group spanning all antigenKeys
  const thAntGroup = document.createElement('th'); thAntGroup.colSpan = Math.max(1, antigenKeys.length); thAntGroup.textContent = 'Antigen'; tr1.appendChild(thAntGroup);

  const thNo = document.createElement('th'); thNo.rowSpan=2; thNo.textContent='No'; tr1.appendChild(thNo);
  tr1.appendChild(Object.assign(document.createElement('th'),{colSpan:4,textContent:'Hasil Pemeriksaan'}));
  thead.appendChild(tr1);

  const tr2 = document.createElement('tr');
  // antigen headers
  antigenKeys.forEach(k => {
    const th = document.createElement('th'); th.textContent = k; tr2.appendChild(th);
  });
  // add test headers
  ['20°C','37°C','IAT','Gel'].forEach(h => {
    const th = document.createElement('th'); th.textContent = h; tr2.appendChild(th);
  });

  thead.appendChild(tr2);
  table.appendChild(thead);

  const tbody = document.createElement('tbody');

  (data.cells || []).forEach((rowObj, idx) => {
    const tr = document.createElement('tr');
    const tdSel = document.createElement('td'); tdSel.textContent = rowObj.sel || (idx+1); tr.appendChild(tdSel);
    const tdRef = document.createElement('td'); tdRef.textContent = rowObj.ref || ''; tr.appendChild(tdRef);

    const ant = rowObj.antigen || {};
    antigenKeys.forEach(k => {
      const td = document.createElement('td'); td.className = 'antigen'; td.textContent = ant[k] || ''; tr.appendChild(td);
    });

    const tdNo = document.createElement('td'); tdNo.textContent = idx+1; tr.appendChild(tdNo);

    tr.appendChild((()=>{ const td=document.createElement('td'); td.appendChild(mkSelect(idx+1,'20c')); return td })());
    tr.appendChild((()=>{ const td=document.createElement('td'); td.appendChild(mkSelect(idx+1,'37c')); return td })());
    tr.appendChild((()=>{ const td=document.createElement('td'); td.appendChild(mkSelect(idx+1,'iat')); return td })());
    tr.appendChild((()=>{ const td=document.createElement('td'); td.appendChild(mkSelect(idx+1,'gel')); return td })());

    tbody.appendChild(tr);
  });

  // auto control row
  const trAuto = document.createElement('tr');
  const tdAuto = document.createElement('td'); tdAuto.colSpan = 2; tdAuto.textContent = 'Auto Kontrol'; trAuto.appendChild(tdAuto);
  const tdSpan = document.createElement('td'); tdSpan.colSpan = Math.max(1, antigenKeys.length); tdSpan.textContent = ''; trAuto.appendChild(tdSpan);
  const tdNoAuto = document.createElement('td'); tdNoAuto.textContent = ''; trAuto.appendChild(tdNoAuto);
  ['20c','37c','iat','gel'].forEach(type => {
    const td = document.createElement('td'); td.appendChild(mkSelect('auto', type)); trAuto.appendChild(td);
  });
  tbody.appendChild(trAuto);

  table.appendChild(tbody);
  wrap.appendChild(table);

  document.getElementById('meta').textContent = `Merk: ${data.meta.merk||'-'}  Lot: ${data.meta.lot||'-'}  Exp: ${data.meta.exp||'-'}`;
  document.getElementById('status').textContent = '';
}

async function refresh(){
  try {
    document.getElementById('status').textContent = 'Memuat...';
    const j = await fetchPanel();
    renderTable(j);
    document.getElementById('status').textContent = 'Data terupdate';
  } catch(err){
    document.getElementById('status').textContent = 'Gagal load: ' + (err.message || err);
    document.getElementById('tableWrap').innerHTML = '';
  }
}

function isReactive(v){
  if(!v) return false;
  const vv = String(v).trim().toLowerCase();
  if(vv === '?' || vv === 'negatif' || vv === 'n.t' || vv === 'nt') return false;
  if(['w','m.f','mf','mf.','mf'].includes(vv)) return true;
  if(/[1-4]\+/.test(vv)) return true;
  if(vv === '+' || /^\+{1,4}$/.test(vv)) return true;
  return false;
}

// find index of antigen header by name (case-insensitive)
function findAntigenColumnIndex(table, antigenName){
  const headers = table.querySelectorAll('thead tr:nth-child(2) th');
  for(let i=0;i<headers.length;i++){
    if(headers[i].innerText.trim().toLowerCase() === antigenName.trim().toLowerCase()) return i;
  }
  return -1;
}

function highlightAntigenColumnsByNames(names){
  // remove previous highlights
  const table = document.querySelector('table');
  if(!table) return;
  table.querySelectorAll('.highlight-antigen').forEach(el => el.classList.remove('highlight-antigen'));
  const headers = table.querySelectorAll('thead tr:nth-child(2) th');
  const bodyRows = table.querySelectorAll('tbody tr');

  names.forEach(n => {
    // find header index among the second row headers
    for(let i=0;i<headers.length;i++){
      const th = headers[i];
      if(th.innerText.trim().toLowerCase() === n.trim().toLowerCase()){
        // header index i corresponds to table column index (offset: first two columns Sel,Ref removed)
        // compute actual colIndex in the row children: Sel,Ref then antigenKeys..., No, tests...
        // We'll iterate rows and find the matching header by text comparison to be safe.
        // Add class to header
        th.classList.add('highlight-antigen');
        // add class to body cells in same visual column position
        // find the absolute column position of this header
        // find position of this header among all thead second row children
        const headerCellsAll = Array.from(table.querySelectorAll('thead tr:nth-child(2) th'));
        // compute column index in row children: 0=Sel,1=Ref, then ant columns...
        const colIndex = 2 + i; // because first two columns are Sel,Ref
        bodyRows.forEach(row => {
          const cell = row.children[colIndex];
          if(cell) cell.classList.add('highlight-antigen');
        });
      }
    }
  });
}

// ANALYSIS (strict)
function analyzePanel(){
  const selects = Array.from(document.querySelectorAll('select[data-cell]'));
  const byCell = {};
  selects.forEach(s => {
    const id = s.dataset.cell;
    byCell[id] = byCell[id] || {};
    byCell[id][s.dataset.type] = s.value;
  });

  // auto control
  const autoVals = selects.filter(s => s.dataset.cell === 'auto').map(s => s.value);
  const autoPositive = autoVals.some(isReactive);
  const autoStatus = autoPositive ? 'Positif' : 'Negatif';
  const autoCauses = autoPositive ? ['autoantibodi','alloantibodi terhadap antigen dengan fenotipe sama','cold agglutinin','reaksi nonspesifik (mis. hiperprotein, obat, dll)'] : [];

  if(!lastPanelData) return alert('Tidak ada data panel (refresh dulu).');
  const cells = lastPanelData.cells || [];

  // build rows
  const rows = cells.map((c, idx) => {
    const id = String(idx+1);
    const r = { sel: c.sel || (idx+1), ref: c.ref||'', antigen: c.antigen||{}, results: byCell[id] || {'20c':'?','37c':'?','iat':'?','gel':'?'} };
    r.reactive = isReactive(r.results['20c']) || isReactive(r.results['37c']) || isReactive(r.results['iat']) || isReactive(r.results['gel']);
    r.reactiveTests = [];
    if(isReactive(r.results['20c'])) r.reactiveTests.push('20°C');
    if(isReactive(r.results['37c'])) r.reactiveTests.push('37°C');
    if(isReactive(r.results['iat'])) r.reactiveTests.push('IAT');
    if(isReactive(r.results['gel'])) r.reactiveTests.push('Gel');
    return r;
  });

  const reactiveRows = rows.filter(r=>r.reactive);
  const nonReactiveRows = rows.filter(r=>!r.reactive);

  // determine antigen keys from cells (union)
  const antigenSet = new Set();
  cells.forEach(c=>{
    Object.keys(c.antigen || {}).forEach(k=>{ if(k) antigenSet.add(k); });
  });
  const antigenKeys = Array.from(antigenSet);

  // strict candidates: present in all reactiveRows and absent in all nonReactiveRows
  const strictCandidates = [];
  antigenKeys.forEach(key=>{
    if(reactiveRows.length === 0) return;
    const presentAll = reactiveRows.every(r => antigenPresent(r.antigen[key]));
    const absentAllNon = nonReactiveRows.every(r => !antigenPresent(r.antigen[key]));
    if(presentAll && absentAllNon) strictCandidates.push(key);
  });

  // show analysis
  const interpretPerRow = rows.map(r => `Sel ${r.sel} (Ref ${r.ref}): ${r.reactive ? 'REAKTIF' : 'NEGATIF'} — reaksi pada: ${r.reactiveTests.join(', ') || '-'}`).join('\n');

  let conclusion = '';
  if(reactiveRows.length === 0){
    conclusion = 'Tidak ditemukan sel reaktif pada suhu 20°/37°C/IAT/Gel.';
  } else if(strictCandidates.length === 0){
    conclusion = 'Tidak ditemukan kandidat antibodi spesifik dengan aturan strict. Pertimbangkan pemeriksaan lanjutan.';
  } else {
    conclusion = `Ditemukan kemungkinan antibodi: ${strictCandidates.map(s=>'anti-'+s).join(', ')}.`;
  }

  const recommendations = [];
  if(strictCandidates.length>0) recommendations.push('Lakukan identifikasi antibodi (panel ID) terhadap kandidat teratas untuk konfirmasi.');
  else recommendations.push('Pertimbangkan pemeriksaan panel identifikasi lanjutan atau ulangi uji dengan panel lain.');
  recommendations.push('Periksa riwayat transfusi/kehamilan dan pastikan crossmatch jika diperlukan.');

  // render analysis UI
  const out = {
    interpretPerRow,
    reactiveCount: reactiveRows.length,
    totalCount: rows.length,
    candidates: strictCandidates,
    conclusion,
    recommendations,
    auto: { status: autoStatus, values: autoVals, causes: autoCauses }
  };
  showAnalysis(out);

  // highlight antigen columns (use candidate names)
  const candidateNames = strictCandidates.slice(); // already antigen names
  highlightAntigenColumnsByNames(candidateNames);
}

function showAnalysis(out){
  const container = document.getElementById('analysisContainer');
  container.innerHTML = '';
  const el = document.createElement('div');
  el.className = 'analysis';

  // interpretation
  const p = document.createElement('div');
  p.innerHTML = '<strong>Interpretasi per sel</strong>';
  const pre = document.createElement('pre'); pre.style.whiteSpace='pre-wrap'; pre.style.background='#f8fafc'; pre.style.padding='8px'; pre.style.borderRadius='6px';
  pre.textContent = out.interpretPerRow;
  p.appendChild(pre);
  el.appendChild(p);

  // summary
  const sum = document.createElement('div'); sum.style.marginTop='8px';
  sum.innerHTML = `<strong>Ringkasan</strong><div>Sel reaktif: <b>${out.reactiveCount}</b> / ${out.totalCount}</div>`;
  el.appendChild(sum);

  // candidates as badges
  const candDiv = document.createElement('div'); candDiv.style.marginTop='8px';
  candDiv.innerHTML = '<strong>Kemungkinan antibodi:</strong>';
  if(out.candidates && out.candidates.length){
    const wrap = document.createElement('div'); wrap.style.marginTop='6px';
    out.candidates.forEach(c=>{
      const sp = document.createElement('span'); sp.className='antibody-badge'; sp.textContent = 'anti-' + c; wrap.appendChild(sp);
    });
    candDiv.appendChild(wrap);
  } else {
    const none = document.createElement('div'); none.textContent = '- Tidak ada kandidat spesifik (strict matching).'; none.style.marginTop='6px'; candDiv.appendChild(none);
  }
  el.appendChild(candDiv);

  // auto control
  const autoDiv = document.createElement('div'); autoDiv.style.marginTop='10px';
  autoDiv.innerHTML = '<strong>Auto Kontrol</strong>';
  autoDiv.innerHTML += `<div style="margin-top:6px">Status: <b>${out.auto.status}</b></div>`;
  if(out.auto.status === 'Positif'){
    let ul = '<div style="margin-top:6px"><em>Kemungkinan penyebab:</em><ul>';
    out.auto.causes.forEach(c=> ul += `<li>${c}</li>`);
    ul += '</ul></div>';
    autoDiv.innerHTML += ul;
    autoDiv.innerHTML += `<div style="margin-top:6px;color:#9a3b00">Catatan: Auto kontrol positif bisa menunjukkan adanya autoantibodi atau faktor nonspesifik; pertimbangkan pemeriksaan lanjutan (auto-adsorpsi, pemanasan serum, dsb).</div>`;
  } else {
    autoDiv.innerHTML += `<div style="margin-top:6px">Tidak ditemukan reaksi pada auto kontrol.</div>`;
  }
  el.appendChild(autoDiv);

  // conclusion & recommendation
  const concl = document.createElement('div'); concl.style.marginTop='10px';
  concl.innerHTML = `<strong>Kesimpulan / rekomendasi</strong><div style="margin-top:6px">${out.conclusion.replace(/\n/g,'<br>')}</div>`;
  let rec = '<div style="margin-top:8px"><em>Rekomendasi:</em><ul>';
  out.recommendations.forEach(r=> rec += `<li>${r}</li>`);
  rec += '</ul></div>';
  concl.innerHTML += rec;
  el.appendChild(concl);

  container.appendChild(el);
}

// local save/load
document.getElementById('refreshBtn').addEventListener('click', refresh);
document.getElementById('analyzeBtn').addEventListener('click', analyzePanel);
document.getElementById('saveBtn').addEventListener('click', ()=>{
  const selects = document.querySelectorAll('select[data-cell]');
  const out = {};
  selects.forEach(s => {
    const id = s.dataset.cell;
    out[id] = out[id] || {};
    out[id][s.dataset.type] = s.value;
  });
  localStorage.setItem('panel_local', JSON.stringify(out));
  alert('Tersimpan ke localStorage');
});
document.getElementById('loadBtn').addEventListener('click', ()=>{
  const raw = localStorage.getItem('panel_local');
  if(!raw) return alert('Tidak ada data tersimpan');
  const obj = JSON.parse(raw);
  Object.keys(obj).forEach(k => {
    const r = obj[k];
    Object.keys(r).forEach(t => {
      const s = document.querySelector('select[data-cell="'+k+'"][data-type="'+t+'"]');
      if(s) s.value = r[t];
    });
  });
  alert('Data dimuat dari localStorage');
});
document.getElementById('exportBtn').addEventListener('click', ()=>{
  const selects = document.querySelectorAll('select[data-cell]');
  const out = {};
  selects.forEach(s => {
    const id = s.dataset.cell;
    out[id] = out[id] || {};
    out[id][s.dataset.type] = s.value;
  });
  const b = new Blob([JSON.stringify(out, null, 2)], { type: 'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'panel_results.json'; a.click(); URL.revokeObjectURL(a.href);
});

// auto-refresh on load
window.addEventListener('load', refresh);
</script>
</body>
</html>
